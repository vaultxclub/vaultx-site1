<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VaultX Dashboard</title>

  <!-- Fonts + CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css">

  <!-- Supabase + Config -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/config.js"></script>

  <style>
    .data-card { margin-bottom: 25px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 10px; border: 1px solid #333; text-align: left; }
    th { background: #111; color: #d4af37; text-transform: uppercase; }
    td input, td select {
      width: 100%; background: #111; border: 1px solid #555;
      color: white; padding: 4px;
    }
    .admin-section {
      margin-top: 40px;
      border-top: 2px solid #d4af37;
      padding-top: 25px;
    }
    .logout {
      float: right;
      font-size: 14px;
      color: #d4af37;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="nav">
    <div class="logo">VAULTX</div>
    <div>
      <a href="index.html">Home</a>
      <a href="calculator.html">Calculator</a>
      <a href="elite.html">Elite</a>
      <a href="rules.html">Rules</a>
      <a href="faq.html">FAQ</a>
      <a href="join.html">Join</a>
      <a href="dashboard.html" class="active">Dashboard</a>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="container">
    <div class="hero">
      <h1>üìä VaultX Dashboard</h1>
      <span class="logout" onclick="logout()">üö™ Logout</span>
      <p>Welcome to your personal member area.</p>
    </div>

    <div class="card data-card" id="memberCard">
      ‚è≥ Loading your data...
    </div>

    <div class="card admin-section" id="adminPanel" style="display:none;">
      <h2>üëë Admin Panel</h2>
      <button class="btn" onclick="loadAllMembers()">üîÑ Refresh Data</button>
      <table class="table">
        <thead>
          <tr>
            <th>Email</th>
            <th>Capital</th>
            <th>Tier</th>
            <th>Expected Profit</th>
            <th>Status</th>
            <th>Elite</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="membersTable"></tbody>
      </table>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    ¬© <span id="year"></span> VaultX ‚Ä¢ 
    <a href="rules.html">Rules</a> ‚Ä¢ 
    <a href="faq.html">FAQ</a>
    <br><br><small id="legal"></small>
  </div>

<script>
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
document.getElementById("year").textContent = new Date().getFullYear();
document.getElementById("legal").textContent = LEGAL_BANNER;

async function loadMember() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    document.getElementById("memberCard").innerHTML = "‚ö†Ô∏è Please login first.";
    return;
  }

  const { data, error } = await supabase
    .from("members")
    .select("*")
    .eq("email", user.email)
    .single();

  if (error || !data) {
    document.getElementById("memberCard").innerHTML = "‚ö†Ô∏è Unable to load your member data. Please contact support.";
    return;
  }

  if (data.status !== "active") {
    document.getElementById("memberCard").innerHTML = `
      <h2>‚è≥ Account Pending</h2>
      <p>Your account is not yet activated by the VaultX team.<br>Please wait for confirmation or contact support.</p>
    `;
    return;
  }

  const tier = VAULTX_TIERS.filter(t => data.capital >= t.capital).pop();
  const gross = data.capital * tier.pct;

  document.getElementById("memberCard").innerHTML = `
    <h2>üë§ Welcome, ${data.email}</h2>
    <p>Status: <b>${data.status}</b></p>
    <p>üíº Investment Overview</p>
    <ul>
      <li>Current Capital: <b>${data.capital} USDT</b></li>
      <li>Current Tier: <b>${tier.capital}</b></li>
      <li>Expected Monthly Profit: <b>${gross.toFixed(2)} USDT</b></li>
      <li>Elite Member: <b>${data.elite_status ? "Yes" : "No"}</b></li>
    </ul>
    <p>üîê Account Info</p>
    <ul>
      <li>Email: ${data.email}</li>
      <li>Joined on: ${new Date(data.join_date).toLocaleDateString()}</li>
    </ul>
  `;

  if (user.email === "vaultxclub@gmail.com") {
    document.getElementById("adminPanel").style.display = "block";
    loadAllMembers();
  }
}

async function loadAllMembers() {
  const { data, error } = await supabase.from("members").select("*");
  const tbody = document.getElementById("membersTable");
  tbody.innerHTML = "";

  data.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${m.email}</td>
      <td><input type="number" value="${m.capital}" onchange="updateMember('${m.id}','capital',this.value)"></td>
      <td>${m.tier || '-'}</td>
      <td>${(m.capital * (VAULTX_TIERS.filter(t=>m.capital>=t.capital).pop().pct)).toFixed(2)}</td>
      <td>
        <select onchange="updateMember('${m.id}','status',this.value)">
          <option ${m.status==='pending'?'selected':''}>pending</option>
          <option ${m.status==='active'?'selected':''}>active</option>
        </select>
      </td>
      <td>
        <select onchange="updateMember('${m.id}','elite_status',this.value==='true')">
          <option value="false" ${!m.elite_status?'selected':''}>No</option>
          <option value="true" ${m.elite_status?'selected':''}>Yes</option>
        </select>
      </td>
      <td><button onclick="deleteMember('${m.id}')">üóë</button></td>
    `;
    tbody.appendChild(tr);
  });
}

async function updateMember(id, field, value) {
  const { error } = await supabase.from("members").update({ [field]: value }).eq("id", id);
  if (!error) loadAllMembers();
}

async function deleteMember(id) {
  if (!confirm("Are you sure?")) return;
  const { error } = await supabase.from("members").delete().eq("id", id);
  if (!error) loadAllMembers();
}

async function logout() {
  await supabase.auth.signOut();
  alert("‚úÖ Logged out successfully");
  window.location.href = "login.html";
}

loadMember();
</script>
</body>
</html>