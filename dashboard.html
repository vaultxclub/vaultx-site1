<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VaultX Dashboard</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="assets/style.css">

  <!-- Supabase + Config -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/config.js"></script>
</head>
<body>
  <!-- NAVBAR -->
  <div class="nav">
    <div class="logo">VAULTX</div>
    <div>
      <a href="index.html">Home</a>
      <a href="calculator.html">Calculator</a>
      <a href="elite.html">Elite</a>
      <a href="rules.html">Rules</a>
      <a href="faq.html">FAQ</a>
      <a href="join.html">Join</a>
      <a href="login.html">Login</a>
      <a href="dashboard.html" class="active">Dashboard</a>
    </div>
  </div>

  <div class="container" id="contentArea">
    <div class="hero">
      <h1>üìä VaultX Member Dashboard</h1>
      <p>Private overview of your membership and investment performance.</p>
    </div>

    <!-- PENDING -->
    <div class="card" id="pendingCard" style="display:none;">
      <h2>‚è≥ Account Pending</h2>
      <p>Your account is not yet activated by the VaultX team.<br>
      Please wait for confirmation or contact support.</p>
    </div>

    <!-- ACTIVE -->
    <div class="card" id="activeSection" style="display:none;">
      <h2>üíº Investment Overview</h2>
      <div id="eliteBadge" style="display:none; margin-bottom:10px; color:#FFD700; font-weight:700; font-size:18px;">
        ‚≠ê ELITE MEMBER
      </div>
      <p>Current Capital: <b id="capital"></b> USDT</p>
      <p>Current Tier: <b id="tier"></b></p>
      <p>Expected Monthly Profit: <b id="profit"></b></p>
      <p>Elite Member: <b id="elite"></b></p>
      <small>* Profit is computed using official tiers from config.js.</small>
    </div>

    <div class="card" id="accountInfo" style="display:none;">
      <h2>üîê Account Info</h2>
      <p>Email: <b id="userEmail"></b></p>
      <p>Joined on: <b id="joinDate"></b></p>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <div class="footer-brand">
      <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#d4af37" width="20" height="20">
        <path d="M12 2l3 5.2 6 .8-4.3 4.3L18.4 19 12 15.8 5.6 19l1.7-6.7L3 8l6-.8z"/>
      </svg>
      <span class="footer-logo">VaultX Investment Club</span>
    </div>
    <div class="footer-links">
      <a href="rules.html">Rules</a> ‚Ä¢
      <a href="faq.html">FAQ</a> ‚Ä¢
      <a href="join.html">Join</a>
    </div>
    <div class="footer-legal">
      <small id="legal"></small>
    </div>
  </div>

<script>
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
document.getElementById("legal").textContent = LEGAL_BANNER;

async function loadUser() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  document.getElementById("userEmail").textContent = user.email;

  if (user.email === "vaultxclub@gmail.com") {
    loadAdminPanel();
  }

  const { data: member, error } = await supabase
    .from("members")
    .select("*")
    .eq("email", user.email)
    .single();

  if (error || !member) {
    document.getElementById("contentArea").innerHTML =
      "<div class='card'><p>‚ö†Ô∏è Unable to load your member data. Please contact support.</p></div>";
    return;
  }

  document.getElementById("joinDate").textContent =
    new Date(member.join_date).toLocaleDateString();

  if (member.status === "pending") {
    document.getElementById("pendingCard").style.display = "block";
    document.getElementById("accountInfo").style.display = "block";
  } else if (member.status === "active") {
    document.getElementById("activeSection").style.display = "block";
    document.getElementById("accountInfo").style.display = "block";

    document.getElementById("capital").textContent = member.capital;
    document.getElementById("tier").textContent = member.tier;
    document.getElementById("elite").textContent = member.elite_status ? "Yes" : "No";

    if (member.elite_status) {
      document.getElementById("eliteBadge").style.display = "block";
    }

    let pct = VAULTX_TIERS[VAULTX_TIERS.length-1].pct;
    for (const t of VAULTX_TIERS) {
      if (member.capital >= t.capital) pct = t.pct;
    }
    const profit = member.capital * pct;
    document.getElementById("profit").textContent =
      `${Math.round(pct*100)}% ‚Äî ${profit.toFixed(2)} USDT`;
  }
}

async function loadAdminPanel() {
  const { data: members } = await supabase.from("members").select("*").order("join_date", { ascending: false });

  const adminDiv = document.createElement("div");
  adminDiv.className = "card";
  adminDiv.innerHTML = `
  <h2>üõ°Ô∏è Admin Panel</h2>
  <input id="searchInput" type="text" placeholder="üîç Search by email..." 
    style="width:100%;padding:10px;margin-bottom:15px;border-radius:8px;border:none;font-size:16px">
  <table class="table" id="adminTable">
    <thead>
      <tr>
        <th>Email</th>
        <th>Capital</th>
        <th>Tier</th>
        <th>Status</th>
        <th>Elite</th>
        <th>Profit Est.</th>
        <th>Joined</th>
        <th>Save</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody>
      ${members.map(m=>{
        let pct = VAULTX_TIERS[VAULTX_TIERS.length-1].pct;
        for (const t of VAULTX_TIERS) {
          if (m.capital >= t.capital) pct = t.pct;
        }
        const profit = (m.capital * pct).toFixed(2);
        const eliteStar = m.elite_status ? "‚≠ê" : "";
        const joined = new Date(m.join_date).toLocaleDateString();
        return `
        <tr>
          <td>${eliteStar} ${m.email}</td>
          <td><input type="number" value="${m.capital}" style="width:80px"></td>
          <td><input type="text" value="${m.tier}" style="width:110px" readonly></td>
          <td>
            <select>
              <option ${m.status==='pending'?'selected':''}>pending</option>
              <option ${m.status==='active'?'selected':''}>active</option>
            </select>
          </td>
          <td><input type="checkbox" ${m.elite_status ? 'checked' : ''}></td>
          <td class="profitCell">${Math.round(pct*100)}% ‚Äî ${profit} USDT</td>
          <td>${joined}</td>
          <td><button onclick="saveMember('${m.email}', this)">üíæ</button></td>
          <td><button style="color:red" onclick="deleteMember('${m.email}', this)">üóëÔ∏è</button></td>
        </tr>`;
      }).join("")}
    </tbody>
  </table>`;

  document.getElementById("contentArea").prepend(adminDiv);

  // Search filter
  document.getElementById("searchInput").addEventListener("input", function() {
    const val = this.value.toLowerCase();
    document.querySelectorAll("#adminTable tbody tr").forEach(tr => {
      const email = tr.children[0].textContent.toLowerCase();
      tr.style.display = email.includes(val) ? "" : "none";
    });
  });

  // Live updates
  document.querySelectorAll("#adminTable tbody tr").forEach(row => {
    const capitalInput = row.children[1].children[0];
    const tierInput = row.children[2].children[0];
    const eliteInput = row.children[4].children[0];
    const emailCell = row.children[0];
    const profitCell = row.children[5];

    capitalInput.addEventListener("input", () => {
      let chosen = VAULTX_TIERS[0];
      for (const t of VAULTX_TIERS) {
        if (parseFloat(capitalInput.value) >= t.capital) chosen = t;
      }
      const pct = chosen.pct;
      const profit = (parseFloat(capitalInput.value) * pct).toFixed(2);
      tierInput.value = `Tier ${chosen.capital}`;
      profitCell.textContent = `${Math.round(pct*100)}% ‚Äî ${profit} USDT`;
    });

    eliteInput.addEventListener("change", () => {
      if (eliteInput.checked) {
        if (!emailCell.textContent.includes("‚≠ê")) {
          emailCell.textContent = "‚≠ê " + emailCell.textContent.trim();
        }
      } else {
        emailCell.textContent = emailCell.textContent.replace("‚≠ê","").trim();
      }
    });
  });
}

async function saveMember(email, btn) {
  const row = btn.closest("tr");
  const capital = parseFloat(row.children[1].children[0].value);
  const tier = row.children[2].children[0].value;
  const status = row.children[3].children[0].value;
  const elite_status = row.children[4].children[0].checked;

  await supabase.from("members")
    .update({ capital, tier, status, elite_status })
    .eq("email", email);

  btn.textContent = "‚úÖ";
  setTimeout(()=>btn.textContent = "üíæ", 1000);
}

async function deleteMember(email, btn) {
  if (!confirm(`Are you sure you want to delete ${email}?`)) return;

  await supabase.from("members")
    .delete()
    .eq("email", email);

  btn.closest("tr").remove();
}
loadUser();
</script>
</body>
</html>